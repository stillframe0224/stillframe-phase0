name: stage3

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  codex-review-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR body for Codex review sections
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          missing=()
          for section in "Codex: RISKS" "Codex: TESTS" "Codex: EDGE"; do
            if ! echo "$PR_BODY" | grep -q "$section"; then
              missing+=("$section")
            fi
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "::error::Missing Codex review sections: ${missing[*]}"
            echo ""
            echo "PR body must contain all three Codex review sections."
            echo "Use the EXACT headings: '## Codex: RISKS', '## Codex: TESTS', '## Codex: EDGE'"
            echo "Note: '## RISKS' (without 'Codex: ' prefix) will NOT pass."
            echo "If using 'gh pr create --body', copy headings from .github/pull_request_template.md"
            exit 1
          fi
          echo "All Codex review sections found."
