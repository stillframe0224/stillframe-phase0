name: Market Pulse Daily

on:
  schedule:
    # 毎日 00:30 UTC = JST 09:30
    - cron: "30 0 * * *"
  workflow_dispatch:
    inputs:
      date:
        description: "Target date (YYYY-MM-DD). Leave empty for today."
        required: false
        default: ""
      dry_run:
        description: "Dry run (no file writes, no commit)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  market-pulse:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        # npm install を使う（新しい依存がlockfileに入るまでの移行期間対応）
        run: npm install --legacy-peer-deps

      - name: Build market pulse
        run: npm run market:pulse:build

      - name: Run market pulse
        run: |
          ARGS=""
          if [ -n "${{ github.event.inputs.date }}" ]; then
            ARGS="$ARGS --date ${{ github.event.inputs.date }}"
          fi
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          npm run market:pulse -- $ARGS

      - name: Check for changes
        id: diff
        run: |
          git add reports/market_pulse/ issues/auto_generated/ 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected. Nothing to commit."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            git diff --cached --stat
          fi

      - name: Commit and push
        if: steps.diff.outputs.changed == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "market-pulse-bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          DATE=$(date -u +"%Y-%m-%d")
          git commit -m "chore(market-pulse): daily report ${DATE}

          Auto-generated by market-pulse workflow.

          Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>"
          git push origin HEAD
          if [ $? -ne 0 ]; then
            echo "ERROR: git push failed. Check permissions and branch protection."
            exit 1
          fi
          echo "Pushed successfully."

      - name: Summary
        if: always()
        run: |
          echo "=== Market Pulse Summary ==="
          if [ -f "reports/market_pulse/candidates.json" ]; then
            COUNT=$(cat reports/market_pulse/candidates.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(len(d))" 2>/dev/null || echo "?")
            echo "Candidates: $COUNT"
          fi
          DATE=$(date -u +"%Y-%m-%d")
          if [ -f "reports/market_pulse/${DATE}.md" ]; then
            echo "Report: reports/market_pulse/${DATE}.md"
            head -10 "reports/market_pulse/${DATE}.md"
          fi
