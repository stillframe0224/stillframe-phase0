name: ui-smoke

# /app UI acceptance smoke --- runs after every push/PR.
# Uses E2E=1 build + ?e2e=1 mock cards (no real auth / service role key needed).
#
# Required secrets (set once in repo Settings -> Secrets -> Actions):
#   NEXT_PUBLIC_SUPABASE_URL   -- Supabase project URL
#   NEXT_PUBLIC_SUPABASE_ANON_KEY -- Supabase anon key
#
# These are needed at build time (next.config.ts injects them) but no real DB
# calls are made in E2E mock mode.

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  pull-requests: write
  issues: write

jobs:
  ui-smoke:
    name: ui-smoke
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      # E2E=1 is REQUIRED at build time (injects __E2E_ALLOWED__ for localhost).
      - name: Build (E2E=1 -- activates mock mode at localhost)
        env:
          E2E: "1"
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: npm run build

      - name: Start server (background)
        env:
          E2E: "1"
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: npm start -- --port 3000 &

      # E2E=1 is REQUIRED at runtime too; app_ui_smoke fails immediately in CI if missing.
      - name: Wait for server + run UI smoke
        env:
          E2E: "1"
          BASE_URL: http://localhost:3000
          CI: "1"
        run: node scripts/app_ui_smoke.mjs

      - name: Upload smoke results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ui-smoke-failure-${{ github.sha }}
          # Never upload storageState (.auth).
          path: |
            reports/ui-smoke/**
            /tmp/stillframe_start.log
          retention-days: 7
          if-no-files-found: ignore

      # Post failure summary as PR comment (upsert -- no comment spam).
      # Only runs on pull_request events; push to main skips this step.
      # Reads reports/ui-smoke/latest/summary.json generated by app_ui_smoke.mjs.
      - name: Comment failure summary on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ARTIFACT_NAME: ui-smoke-failure-${{ github.sha }}
        with:
          script: |
            const { execSync } = require("child_process");
            const sha = process.env.SHA;
            const runUrl = process.env.RUN_URL;
            const artifactName = process.env.ARTIFACT_NAME;

            // Generate comment body via formatter script
            let body;
            try {
              body = execSync(
                `node scripts/format_ui_smoke_failure_comment.mjs` +
                ` --summary reports/ui-smoke/latest/summary.json` +
                ` --sha ${sha}` +
                ` --run-url "${runUrl}"` +
                ` --artifact-name "${artifactName}"`,
                { encoding: "utf8" }
              );
            } catch (e) {
              // Formatter failed -- emit minimal fallback
              const shortSha = sha.slice(0, 7);
              body = [
                "<!-- UI_SMOKE_FAIL_DETAIL -->",
                "### ui-smoke failed",
                "",
                `- **sha:** \`${shortSha}\``,
                `- **run:** [Actions run](${runUrl})`,
                `- **artifacts:** \`${artifactName}\` _(Actions -> Artifacts)_`,
                `- **detail:** formatter error: ${e.message.slice(0, 200)}`,
              ].join("\n");
            }

            const marker = "<!-- UI_SMOKE_FAIL_DETAIL -->";
            const prNumber = context.payload.pull_request.number;

            // Upsert: find existing comment with our marker
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.data.find(
              (c) => typeof c.body === "string" && c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
              core.info(`Updated ui-smoke failure comment on PR #${prNumber}`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
              core.info(`Posted ui-smoke failure comment on PR #${prNumber}`);
            }
