#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
NOTIFIER="$REPO_ROOT/tools/notify/ntfy.mjs"

cd "$REPO_ROOT"

# Auto-load local notify env if present.
if [ -f ".env.local" ]; then
  set -a
  # shellcheck disable=SC1091
  source ".env.local"
  set +a
fi

if [ -z "${NTFY_SERVER:-}" ]; then
  NTFY_SERVER="https://ntfy.sh"
fi
export NTFY_SERVER

if [ -z "${NTFY_TOPIC:-}" ]; then
  echo "[FATAL] NTFY_TOPIC is required. Set it in .env.local or env." >&2
  exit 64
fi

START_TS="$(date +%s)"
PREVIEW=""
CODE=0

if [ "$#" -gt 0 ]; then
  PROMPT="$*"
  PREVIEW="$(printf '%s' "$PROMPT" | tr '\n' ' ' | cut -c1-120)"
  set +e
  codex exec \
    --cd /Users/array0224/stillframe-phase0 \
    --sandbox workspace-write \
    --ask-for-approval never \
    --config sandbox_workspace_write.network_access=true \
    "$PROMPT"
  CODE="$?"
  set -e
else
  PROMPT_STDIN="$(cat)"
  PREVIEW="(stdin)"
  set +e
  printf '%s' "$PROMPT_STDIN" | codex exec \
    --cd /Users/array0224/stillframe-phase0 \
    --sandbox workspace-write \
    --ask-for-approval never \
    --config sandbox_workspace_write.network_access=true \
    -
  CODE="$?"
  set -e
fi

END_TS="$(date +%s)"
DURATION="$((END_TS - START_TS))"

if [ "$CODE" -eq 0 ]; then
  TITLE="✅ codex done"
  PRIORITY="3"
else
  TITLE="❌ codex fail($CODE)"
  PRIORITY="4"
fi

MESSAGE="${DURATION}s | ${PREVIEW}"

node "$NOTIFIER" --title "$TITLE" --message "$MESSAGE" --priority "$PRIORITY" >/dev/null 2>&1 || true

exit "$CODE"
