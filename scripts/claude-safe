#!/bin/bash
set -euo pipefail

ROOT="/Users/array0224/stillframe-phase0"
cd "$ROOT"

source "$ROOT/scripts/_local_sound.sh" || true

usage() {
  printf '%s\n' \
    "Usage: scripts/claude-safe [claude args...]" \
    "" \
    "Wrapper for ClaudeCode CLI with local iMac sound notifications." \
    "- success: Glass x1" \
    "- failure: Basso x2" \
    "- attention: Submarine x3" \
    "" \
    "Set IMAC_SOUND=0 to disable local sounds."
}

pick_claude_bin() {
  if [ -n "${CLAUDE_BIN:-}" ] && command -v "$CLAUDE_BIN" >/dev/null 2>&1; then
    printf '%s' "$CLAUDE_BIN"
    return 0
  fi

  local candidates=("claude" "claude-code" "claudecode")
  local c
  for c in "${candidates[@]}"; do
    if command -v "$c" >/dev/null 2>&1; then
      printf '%s' "$c"
      return 0
    fi
  done

  return 1
}

contains_arg() {
  local needle="$1"
  shift
  local x
  for x in "$@"; do
    if [ "$x" = "$needle" ]; then
      return 0
    fi
  done
  return 1
}

if [ $# -gt 0 ]; then
  case "$1" in
    -h|--help|help)
      usage
      exit 0
      ;;
  esac
fi

BIN="$(pick_claude_bin || true)"
if [ -z "$BIN" ]; then
  local_sound_attention || true
  echo "[claude-safe] ClaudeCode binary not found (CLAUDE_BIN/claude/claude-code/claudecode)" >&2
  exit 127
fi

RUN_ARGS=("$@")
run_log="$(mktemp /tmp/claude-safe.log.XXXXXX)"
watcher_pid=""

start_attention_watcher() {
  (
    source "$ROOT/scripts/_local_sound.sh" || true
    seen=0
    while IFS= read -r line; do
      if [ "$seen" -eq 0 ] && printf '%s\n' "$line" | grep -Eiq 'permission|approve|approval|yes/no|実行しますか|許可'; then
        local_sound_attention || true
        seen=1
      fi
    done < <(tail -n 0 -F "$run_log" 2>/dev/null)
  ) &
  echo "$!"
}

stop_attention_watcher() {
  if [ -n "$watcher_pid" ]; then
    kill "$watcher_pid" >/dev/null 2>&1 || true
    watcher_pid=""
  fi
}

run_once() {
  : > "$run_log"
  watcher_pid="$(start_attention_watcher)"

  set +e
  "$BIN" "$@" 2>&1 | tee -a "$run_log"
  local rc=${PIPESTATUS[0]}
  set -e

  stop_attention_watcher
  return "$rc"
}

has_unknown_option_error() {
  grep -Eiq 'unknown option|unrecognized option|invalid option' "$run_log"
}

first_try_args=("${RUN_ARGS[@]}")
if ! contains_arg "--dangerously-skip-permissions" "${RUN_ARGS[@]:-}"; then
  first_try_args=("--dangerously-skip-permissions" "${RUN_ARGS[@]}")
fi

cmd_rc=0
if run_once "${first_try_args[@]}"; then
  cmd_rc=0
else
  cmd_rc=$?
fi

if ! contains_arg "--dangerously-skip-permissions" "${RUN_ARGS[@]:-}" && has_unknown_option_error; then
  echo "[claude-safe] --dangerously-skip-permissions not supported; retrying without it." >&2
  if run_once "${RUN_ARGS[@]}"; then
    cmd_rc=0
  else
    cmd_rc=$?
  fi
fi

stop_attention_watcher
rm -f "$run_log" >/dev/null 2>&1 || true

if [ "$cmd_rc" -eq 0 ]; then
  local_sound_success || true
else
  local_sound_failure || true
fi

exit "$cmd_rc"
