# Zen Mono — Implementation Report

## Summary
Complete implementation of the Zen Mono spec: deterministic non-overlap layout engine, drag state machine, monochrome redesign, performance auto-degradation, CSS 3D can, and debug hooks.

## Implementation Locations

### 1. Layout Engine + Coordinate System
- **`app/app/tunnelLayout.ts`** (NEW)
  - `autoArrange()`: spatial hash + AABB, row-by-row with stagger, grid fallback after 50 nudges
  - `aabbOverlap()`: AABB collision with epsilon
  - `screenToWorld()` / `worldToScreen()`: coordinate conversion (screen = world * zoom + pan)
  - `countOverlapPairs()`: overlap counting for assertions
  - `getEpsilon()`: `max(1, 0.5/devicePixelRatio)`
  - Zero-size cards excluded with warning count

### 2. Drag State Machine
- **`app/app/tunnelDragFSM.ts`** (NEW)
  - States: `idle | dragging | settling`
  - Events: `DRAG_START | DRAG_END | SETTLE_COMPLETE | RESET_REQUEST`
  - `transition()`: pure function, no side effects
  - `pendingReset` capped at 1 (queue-1 pattern)
  - Settling: 1-frame rAF delay after drag end

### 3. Reset SSOT
- **`app/app/useTunnelStore.ts`** (REWRITTEN)
  - `resetAll(cardSizes?)`: camera={0,0,1} + autoArrange positions
  - `arrangeCards(cardSizes?)`: rearrange without camera reset
  - Old layouts (scatter/grid/circle) removed; storage compat: old layout values → "auto-v1"
- **`app/app/TunnelCanvas.tsx`**
  - `handleResetRequest()`: idle → execute immediately; dragging/settling → queue via FSM
  - Escape key → handleResetRequest (combines view reset + non-overlap arrange)
  - R key → camera-only reset (orbit + pan + zoom)

### 4. ResizeObserver Guard
- **`app/app/TunnelCanvas.tsx`**
  - Observer sets `dirtySizeRef.current = true` only
  - Re-layout batched in rAF (1 per frame)
  - During settling/dragging: suppressed
  - After settling complete + dirtySize: debounce 80ms then one re-layout

### 5. Non-Overlap Guarantee
- **Reset completion condition**: state=idle, overlapPairs===0 in world coords
- **Epsilon**: `max(1px, 0.5/devicePixelRatio)`
- **Width/height=0**: excluded from layout, counted in `zeroSizeCount`
- **Spatial hash**: cell size = avg(width) + GAP(40px)

### 6. Monochrome (No Filter)
- **`lib/cardTypes.ts`**: MONO_SYMBOLS + MONO_ACCENTS maps
- **`app/app/AppCard.tsx`**: white bg, 1px gray border, 3px left accent line, gray chip, gray SVG fallbacks
- **`app/components/ThoughtCard.tsx`**: same pattern
- **`app/page.tsx`**: gray type selector, gray dots, gray add button, gray howImages icons
- **`app/globals.css`**: `--sh-ink-sub: rgba(0,0,0,0.25)` added
- **`app/app/tunnel.css`**: zen background (faint vertical lines at 80px, rgba(0,0,0,0.015))
- **No CSS filter/grayscale** on any images

### 7. Performance Degradation Layer
- **`app/app/tunnelPerfMonitor.ts`** (NEW)
  - Quality tiers: `full → no-shadow → no-3d → no-anim`
  - Degradation: 3 consecutive frames > 16ms → step down
  - Recovery hysteresis: 30 consecutive frames < 12ms → step up
  - `createPerfMonitor()`, `recordFrameTime()`, `tierCssClass()`
  - Mobile: start at `no-shadow` if maxTouchPoints > 0 && innerWidth < 768
- **`app/app/tunnel.css`**: perf CSS classes
  - `.perf-no-shadow .tunnel-card { box-shadow: none !important; }`
  - `.perf-no-3d .tunnel-stage { transform-style: flat; }`
  - `.perf-no-anim .tunnel-card { transition: none !important; }`

### 8. Debug Hooks
- **`app/app/TunnelCanvas.tsx`**: `window.__SHINEN_DEBUG__`
  - `overlapPairs`: number of overlapping card pairs
  - `queuedReset`: 0 or 1
  - `state`: "idle" | "dragging" | "settling"
  - `qualityTier`: "full" | "no-shadow" | "no-3d" | "no-anim"
  - Updated on position changes, drag start/end, reset

### 9. CSS 3D Can (LP)
- **`app/components/ZenCan.tsx`** (NEW)
  - 12 rotated faces forming cylinder via `rotateY(i*30deg) translateZ(60px)`
  - Gradient per face simulating lighting
  - Noise overlay via inline SVG data URI
  - `@keyframes canSway` 30s rotation
  - `@media (prefers-reduced-motion: reduce)` → static pose

## Tests

### Unit Tests (vitest) — 36 tests, all pass
- `__tests__/tunnelLayout.test.ts` (15 tests)
  - AABB: overlap, non-overlap, adjacent, epsilon edge cases, zero-size
  - world<->screen roundtrip (error < 1e-10)
  - autoArrange: deterministic, 100-card zero overlap, zero-size exclusion, grid fallback
- `__tests__/tunnelDragFSM.test.ts` (10 tests)
  - All state transitions, layoutLock, queue-1 reset, settle cancel, invalid event handling
- `__tests__/tunnelPerfMonitor.test.ts` (11 tests)
  - Fast frames no degrade, 3-slow trigger, degradation order, 12ms recovery threshold, hysteresis, step-by-step recovery

### E2E Test
- `e2e/zen-overlap.spec.ts`
  - Navigate to tunnel view
  - Drag + Escape spam (5x reset during drag)
  - Zoom in/out
  - Final assert: state=idle, queuedReset<=1

## E2E Wait Conditions (Flake Prevention)
- `waitForFunction()` for `__SHINEN_DEBUG__` availability (10s timeout)
- `waitForTimeout(200)` after drag end for settle rAF
- `waitForTimeout(500)` after final reset for layout completion
- No race conditions: debug hook reads are synchronous snapshots

## File Changes Summary
| File | Change |
|---|---|
| `app/app/tunnelLayout.ts` | NEW — layout engine, coord helpers, overlap counting |
| `app/app/tunnelDragFSM.ts` | NEW — drag/layout FSM |
| `app/app/tunnelPerfMonitor.ts` | NEW — perf monitor with hysteresis |
| `app/app/useTunnelStore.ts` | MAJOR — removed old layouts, uses autoArrange |
| `app/app/TunnelCanvas.tsx` | MAJOR — FSM, ResizeObserver guard, perf monitor, debug hooks |
| `app/app/TunnelCardWrapper.tsx` | MINOR — onDragStart/End, data-card-id |
| `app/app/tunnel.css` | MODERATE — zen bg, perf classes, removed layout badge |
| `lib/cardTypes.ts` | MINOR — MONO_SYMBOLS/ACCENTS |
| `app/app/AppCard.tsx` | MAJOR — full monochrome conversion |
| `app/components/ThoughtCard.tsx` | MODERATE — monochrome SVGs/styling |
| `app/page.tsx` | MODERATE — mono LP, ZenCan integration |
| `app/globals.css` | MINOR — --sh-ink-sub |
| `app/components/ZenCan.tsx` | NEW — CSS 3D cylinder |
| `vitest.config.ts` | NEW — test config |
| `__tests__/*.test.ts` | NEW — 3 unit test files (36 tests) |
| `e2e/zen-overlap.spec.ts` | NEW — E2E overlap test |
| `package.json` | MINOR — vitest devDep, test script |
